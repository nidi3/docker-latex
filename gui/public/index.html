<!DOCTYPE html>
<html lang="en">
<head>
    <title>LaTex</title>
    <style type="text/css" media="screen">
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        .error {
            color: #800;
            cursor: pointer;
        }

        button {
            margin: 1em;
            padding: .5em;
        }

        #menu {
            height: 50px;
            width: 100%;
            line-height: 50px;
        }

        #editor-container {
            position: absolute;
            top: 50px;
            bottom: 300px;
            left: 0;
            padding: 10px;
            width: 50%;
        }

        #editor {
            height: 100%;
            width: 100%;
        }

        #log-container {
            position: absolute;
            height: 300px;
            bottom: 0;
            left: 0;
            width: 50%;
            padding: 10px;
        }

        #log {
            border: 1px solid black;
            height: 100%;
            width: 100%;
            padding: 5px;
            overflow: auto;
        }

        #view {
            position: absolute;
            top: 50px;
            bottom: 0;
            left: 50%;
            width: 50%;
            padding: 10px;
            overflow: auto;
        }

        .ace_linkable {
            position: absolute;
            background-color: blue;
            opacity: .2;
        }
    </style>
</head>
<body>
<div id="menu">
    <button onclick="last()">Last</button>
    <button onclick="next()">Next</button>
    <button onclick="setScaleFunc(scaleFit)">Scale fit</button>
    <button onclick="setScaleFunc(scaleHeight)">Scale height</button>
    <button onclick="setScaleFunc(scaleWidth)">Scale width</button>
    <button onclick="zoomOut()">-</button>
    <span id="zoom" style="display: inline-block; width: 3em; text-align: center">100%</span>
    <button onclick="zoomIn()">+</button>
    <a href="/doc/main.pdf?download">Download</a>
</div>

<div id="editor-container">
    <div id="editor"></div>
</div>

<div id="log-container">
    <div id="log"></div>
</div>

<div id="view">
    <canvas id="pdf" style="position: absolute; margin: 10px; border: 1px solid black"></canvas>
</div>

<script src="../ace-builds/src/ace.js" type="text/javascript" charset="utf-8"></script>
<script src="../ace-builds/src/ext-language_tools.js" type="text/javascript" charset="utf-8"></script>
<script src="../pdfjs-dist/build/pdf.combined.js" type="text/javascript" charset="utf-8"></script>
<script>
    var langTools = ace.require("ace/ext/language_tools");
    var editor = ace.edit("editor");
    editor.setTheme("ace/theme/clouds");
    editor.getSession().setMode("ace/mode/latex");
    editor.setOptions({
        enableBasicAutocompletion: true,
        enableSnippets: true,
        enableLiveAutocompletion: false
    });

    fetch(new Request('/doc/main.tex'))
            .then(res=>res.text())
            .then(text=> {
                editor.setValue(text);
                editor.clearSelection();
            });

    var texinfo = 'http://mirror.switch.ch/ftp/mirror/tex/info/latex2e-help-texinfo/latex2e.html';
    var help = {
        '\\documentclass': {help: texinfo + '#Document-classes', type: 'command'},
        '\\usepackage': {help: null, type: 'command'},
        '\\maketitle': {help: texinfo + '#g_t_005cmaketitle-1', type: 'command'},
        '\\author': {help: texinfo + '#g_t_005cmaketitle-1', type: 'command'},
        '\\date': {help: texinfo + '#g_t_005cmaketitle-1', type: 'command'},
        '\\thanks': {help: texinfo + '#g_t_005cmaketitle-1', type: 'command'},
        '\\title': {help: texinfo + '#g_t_005cmaketitle-1', type: 'command'},
        '\\begin': {help: texinfo + '#Environments', type: 'command'},
        '\\end': {help: texinfo + '#Environments', type: 'command'},
        'abstract': {help: texinfo + '#abstract', type: 'env'},
        'array': {help: texinfo + '#array', type: 'env'},
        'center': {help: texinfo + '#center', type: 'env'},
        'description': {help: texinfo + '#description', type: 'env'},
        'displaymath': {help: texinfo + '#displaymath', type: 'env'},
        'document': {help: texinfo + '#document', type: 'env'},
        'enumerate': {help: texinfo + '#enumerate', type: 'env'},
        'eqnarray': {help: texinfo + '#eqnarray', type: 'env'},
        'equation': {help: texinfo + '#equation', type: 'env'},
        'figure': {help: texinfo + '#figure', type: 'env'},
        'filecontents': {help: texinfo + '#filecontents', type: 'env'},
        'flushleft': {help: texinfo + '#flushleft', type: 'env'},
        '\\raggedright': {help: texinfo + '#raggedright', type: 'env'},
        'flushright': {help: texinfo + '#flushright', type: 'env'},
        '\\raggedleft': {help: texinfo + '#raggedleft', type: 'env'},
        'itemize': {help: texinfo + '#itemize', type: 'env'},
        '\\item': {help: texinfo + '#itemize', type: 'command'},
        'letter': {help: texinfo + '#letter', type: 'env'},
        'list': {help: texinfo + '#list', type: 'env'},
        'math': {help: texinfo + '#math', type: 'env'},
        'minipage': {help: texinfo + '#minipage', type: 'env'},
        'picture': {help: texinfo + '#picture', type: 'env'},
        'quotation': {help: texinfo + '#quotation-and-quote', type: 'env'},
        'quote': {help: texinfo + '#quotation-and-quote', type: 'env'},
        'tabbing': {help: texinfo + '#tabbing', type: 'env'},
        'table': {help: texinfo + '#table', type: 'env'},
        'tabular': {help: texinfo + '#tabular', type: 'env'},
        'thebibliography': {help: texinfo + '#thebibliography', type: 'env'},
        'theorem': {help: texinfo + '#theorem', type: 'env'},
        'titlepage': {help: texinfo + '#titlepage', type: 'env'},
        'verbatim': {help: texinfo + '#verbatim', type: 'env'},
        'verse': {help: texinfo + '#verse', type: 'env'},
        '\\part': {help: texinfo + '#Sectioning', type: 'command'},
        '\\chapter': {help: texinfo + '#Sectioning', type: 'command'},
        '\\section': {help: texinfo + '#Sectioning', type: 'command'},
        '\\subsection': {help: texinfo + '#Sectioning', type: 'command'},
        '\\subsubsection': {help: texinfo + '#Sectioning', type: 'command'},
        '\\paragraph': {help: texinfo + '#Sectioning', type: 'command'},
        '\\subparagraph': {help: texinfo + '#Sectioning', type: 'command'},
        '\\textrm': {help: texinfo + '#Fonts', type: 'command'},
        '\\rmfamily': {help: texinfo + '#Fonts', type: 'command'},
        '\\textit': {help: texinfo + '#Fonts', type: 'command'},
        '\\itshape': {help: texinfo + '#Fonts', type: 'command'},
        '\\textmd': {help: texinfo + '#Fonts', type: 'command'},
        '\\mdseries': {help: texinfo + '#Fonts', type: 'command'},
        '\\textbf': {help: texinfo + '#Fonts', type: 'command'},
        '\\bfseries': {help: texinfo + '#Fonts', type: 'command'},
        '\\textup': {help: texinfo + '#Fonts', type: 'command'},
        '\\upshape': {help: texinfo + '#Fonts', type: 'command'},
        '\\textsl': {help: texinfo + '#Fonts', type: 'command'},
        '\\slshape': {help: texinfo + '#Fonts', type: 'command'},
        '\\textsf': {help: texinfo + '#Fonts', type: 'command'},
        '\\sffamily': {help: texinfo + '#Fonts', type: 'command'},
        '\\textsc': {help: texinfo + '#Fonts', type: 'command'},
        '\\scshape': {help: texinfo + '#Fonts', type: 'command'},
        '\\texttt': {help: texinfo + '#Fonts', type: 'command'},
        '\\ttfamily': {help: texinfo + '#Fonts', type: 'command'},
        '\\textnormal': {help: texinfo + '#Fonts', type: 'command'},
        '\\normalfont': {help: texinfo + '#Fonts', type: 'command'},
        '\\bf': {help: texinfo + '#Fonts', type: 'command'},
        '\\cal': {help: texinfo + '#Fonts', type: 'command'},
        '\\it': {help: texinfo + '#Fonts', type: 'command'},
        '\\rm': {help: texinfo + '#Fonts', type: 'command'},
        '\\sc': {help: texinfo + '#Fonts', type: 'command'},
        '\\sf': {help: texinfo + '#Fonts', type: 'command'},
        '\\sl': {help: texinfo + '#Fonts', type: 'command'},
        '\\tt': {help: texinfo + '#Fonts', type: 'command'},
        '\\mathrm': {help: texinfo + '#Fonts', type: 'command'},
        '\\mathbf': {help: texinfo + '#Fonts', type: 'command'},
        '\\mathsf': {help: texinfo + '#Fonts', type: 'command'},
        '\\mathtt': {help: texinfo + '#Fonts', type: 'command'},
        '\\mathit': {help: texinfo + '#Fonts', type: 'command'},
        '\\mit': {help: texinfo + '#Fonts', type: 'command'},
        '\\mathnormal': {help: texinfo + '#Fonts', type: 'command'},
        '\\mathcal': {help: texinfo + '#Fonts', type: 'command'},
        '\\tiny': {help: texinfo + '#Font-sizes', type: 'command'},
        '\\scriptsize': {help: texinfo + '#Font-sizes', type: 'command'},
        '\\footnotesize': {help: texinfo + '#Font-sizes', type: 'command'},
        '\\small': {help: texinfo + '#Font-sizes', type: 'command'},
        '\\normalsize': {help: texinfo + '#Font-sizes', type: 'command'},
        '\\large': {help: texinfo + '#Font-sizes', type: 'command'},
        '\\Large': {help: texinfo + '#Font-sizes', type: 'command'},
        '\\LARGE': {help: texinfo + '#Font-sizes', type: 'command'},
        '\\huge': {help: texinfo + '#Font-sizes', type: 'command'},
        '\\Huge': {help: texinfo + '#Font-sizes', type: 'command'},
        '\\label': {help: texinfo + '#g_t_005clabel', type: 'command'},
        '\\pageref': {help: texinfo + '#g_t_005cpageref', type: 'command'},
        '\\ref': {help: texinfo + '#g_t_005cref', type: 'command'},
        '\\include': {help: texinfo + '#g_t_005cinclude', type: 'command'},
        '\\includeonly': {help: texinfo + '#g_t_005cincludeonly', type: 'command'},
        '\\input': {help: texinfo + '#g_t_005cinput', type: 'command'},
        '\\cleardoublepage': {help: texinfo + '#g_t_005ccleardoublepage', type: 'command'},
        '\\clearpage': {help: texinfo + '#g_t_005cclearpage', type: 'command'},
        '\\newpage': {help: texinfo + '#g_t_005cnewpage', type: 'command'},
        '\\enlargethispage': {help: texinfo + '#g_t_005cenlargethispage', type: 'command'},
        '\\pagebreak': {help: texinfo + '#g_t_005cpagebreak-_0026-_005cnopagebreak', type: 'command'},
        '\\nopagebreak': {help: texinfo + '#g_t_005cpagebreak-_0026-_005cnopagebreak', type: 'command'},
        '\\hspace': {help: texinfo + '#g_t_005chspace', type: 'command'},
        '\\hfill': {help: texinfo + '#g_t_005chfill', type: 'command'},
        '\\thinspace': {help: texinfo + '#g_t_005cthinspace', type: 'command'},
        '\\hrulefill': {help: texinfo + '#g_t_005chrulefill-_005cdotfill', type: 'command'},
        '\\dotfill': {help: texinfo + '#g_t_005chrulefill-_005cdotfill', type: 'command'},
        '\\addvspace': {help: texinfo + '#g_t_005caddvspace', type: 'command'},
        '\\bigskip': {help: texinfo + '#g_t_005cbigskip-_005cmedskip-_005csmallskip', type: 'command'},
        '\\medskip': {help: texinfo + '#g_t_005cbigskip-_005cmedskip-_005csmallskip', type: 'command'},
        '\\smallskip': {help: texinfo + '#g_t_005cbigskip-_005cmedskip-_005csmallskip', type: 'command'},
        '\\vfill': {help: texinfo + '#g_t_005cvfill', type: 'command'},
        '\\vspace': {help: texinfo + '#g_t_005cvspace', type: 'command'},
    };

    langTools.addCompleter({
        getCompletions: (editor, session, pos, prefix, callback)=> {
            var token = editor.session.getTokenAt(pos.row, pos.column);
            var lastToken = editor.session.getTokenAt(pos.row, pos.column - prefix.length - 1);
            var isEnv = lastToken && (lastToken.value === '\\begin' || lastToken.value === '\\end');
            var isCommand = token && token.value && token.value.charAt(0) === '\\';
            var res = [];
            for (var h in help) {
                var he = help[h];
                if (isCommand && he.type === 'command' && h.substring(1, prefix.length + 1) === prefix) {
                    res.push({caption: h, snippet: h.substring(1) + '{$0}', meta: he.type, score: 2000});
                }
                if (isEnv && he.type === 'env' && h.substring(0, prefix.length) === prefix) {
                    res.push({caption: h, value: h, meta: he.type, score: 2000});
                }
            }
            callback(null, res);
        }
    });

    var Range = ace.require("ace/range").Range, markerId;
    editor.on('click', e=> {
        if (e.domEvent.metaKey) {
            var pos = editor.getCursorPosition();
            var token = editor.session.getTokenAt(pos.row, pos.column);
            var link = tokenLink(token);
            if (link) {
                window.open(link, 'latex-help');
            }
        }
    });
    editor.on('mousemove', e=> {
        if (!markLinkable(e)) {
            editor.session.removeMarker(markerId);
            editor.renderer.setCursorStyle("");
        }
    });

    function markLinkable(e) {
        if (e.domEvent.metaKey) {
            var renderer = editor.renderer;

            var canvasPos = renderer.scroller.getBoundingClientRect();
            var offset = (e.x + renderer.scrollLeft - canvasPos.left - renderer.$padding) / renderer.characterWidth;
            var row = Math.floor((e.y + renderer.scrollTop - canvasPos.top) / renderer.lineHeight);
            var col = Math.round(offset);
            var screenPos = {row: row, column: col, side: offset - col > 0 ? 1 : -1};
            var session = editor.session;
            var pos = session.screenToDocumentPosition(screenPos.row, screenPos.column);

            var token = editor.session.getTokenAt(pos.row, pos.column);
            if (tokenLink(token)) {
                editor.session.removeMarker(markerId);
                editor.renderer.setCursorStyle("pointer");
                var range = new Range(pos.row, token.start, pos.row, token.start + token.value.length);
                markerId = editor.session.addMarker(range, 'ace_linkable', 'text', true);
                return true;
            }
        }
        return false;
    }

    function tokenLink(token) {
        if (token && (token.type === 'keyword' || token.type === 'storage.type' || token.type === 'variable.parameter')) {
            var h = help[token.value];
            return h && h.help;
        }
        return false;

    }

    var pageNum = 1;
    var pdf, page;
    var scaleFunc = scaleFit;
    var scale = 1;
    var elem = {
        zoom: document.getElementById('zoom'),
        log: document.getElementById('log'),
        view: document.getElementById('view'),
        canvas: document.getElementById('pdf'),
    };
    var renderContext = {
        canvasContext: elem.canvas.getContext('2d'),
        viewport: null
    };

    editor.commands.addCommand({
        name: 'save',
        bindKey: {win: 'Ctrl-S', mac: 'Command-S'},
        exec: function (editor) {
            var start = Date.now();
            log.innerHTML = '';
            fetch(new Request('/action/save', {method: 'POST', body: editor.getValue()}))
                    .then(res=> {
                        console.log(Date.now() - start);
                        res.text().then(text=> {
                            var errorPos = text.indexOf('\n./main.tex:');
                            var firstLine;
                            while (errorPos >= 0) {
                                var line = parseInt(text.substring(errorPos + 12, text.indexOf(':', errorPos + 12)));
                                var errorEnd = text.indexOf('\n', errorPos + 1);
                                text = text.substring(0, errorPos + 1) +
                                        '<span class="error" onclick="editor.gotoLine(' + line + '); editor.focus()">' + text.substring(errorPos + 1, errorEnd) + '</span>' +
                                        text.substring(errorEnd);
                                firstLine = firstLine || line;
                                errorPos = text.indexOf('\n./main.tex:', errorEnd);
                            }
                            log.innerHTML = text.replace(/\n/g, '<br>');
                            if (firstLine) {
                                editor.gotoLine(firstLine);
                                log.querySelector('.error').scrollIntoView();
                            }
                        });
                        return PDFJS.getDocument('/doc/main.pdf');
                    })
                    .then(p=> {
                        pdf = p;
                        pageNum = Math.min(pageNum, pdf.numPages);
                        renderPage();
                    })
            ;
        }
    });

    window.onresize = renderPage;

    function renderPage() {
        pdf.getPage(pageNum).then(p=> {
            page = p;
            scaleFunc();
            elem.canvas.width = renderContext.viewport.width;
            elem.canvas.height = renderContext.viewport.height;
            elem.canvas.style.left = Math.max(0, (viewWidth() - renderContext.viewport.width) / 2) + 'px';
            elem.canvas.style.top = Math.max(0, (viewHeight() - renderContext.viewport.height) / 2) + 'px';
            page.render(renderContext);
        });
    }

    function scaleFit() {
        var view = page.view;
        setScale(Math.min(viewWidth() / view[2], viewHeight() / view[3]));
    }

    function scaleHeight() {
        setScale(viewHeight() / page.view[3]);
    }

    function scaleWidth() {
        setScale(viewWidth() / page.view[2]);
    }

    function viewWidth() {
        var style = window.getComputedStyle(elem.view);
        return elem.view.offsetWidth - parseInt(style.paddingLeft) - parseInt(style.paddingRight);
    }
    function viewHeight() {
        var style = window.getComputedStyle(elem.view);
        return elem.view.offsetHeight - parseInt(style.paddingTop) - parseInt(style.paddingBottom);
    }

    function setScale(s) {
        scale = s;
        elem.zoom.textContent = Math.round(s * 100) + "%";
        renderContext.viewport = page.getViewport(scale);
    }

    function setScaleFunc(sf) {
        scaleFunc = sf;
        renderPage();
    }

    function zoomIn() {
        setScale(scale * 1.2);
        scaleFunc = ()=> {
        };
        renderPage();
    }

    function zoomOut() {
        setScale(scale / 1.2);
        scaleFunc = ()=> {
        };
        renderPage();
    }

    function last() {
        if (pageNum > 1) {
            pageNum--;
            renderPage();
        }
    }

    function next() {
        if (pageNum < pdf.numPages) {
            pageNum++;
            renderPage()
        }
    }

</script>
</body>
</html>